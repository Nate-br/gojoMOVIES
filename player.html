<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gojo Films - Player</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="info" aria-live="polite" aria-atomic="true">Loading...</div>

  <div id="playerWrapper" aria-label="YouTube video player wrapper">
    <div id="externalCover" aria-hidden="true" title="Cover YouTube UI"></div>

    <div id="playerContainer" aria-label="YouTube video player container">
      <div id="player" role="region" aria-live="off" aria-atomic="true"></div>

      <!-- Subtle gradients only -->
      <div class="branding-cover-overlay" aria-hidden="true"></div>
      <div class="top-branding-cover" aria-hidden="true"></div>

      <div id="interactionShield" aria-hidden="true" title="Interaction Shield"></div>

      <!-- Pause overlay (visible first) -->
      <div id="pauseCover" title="Paused" role="button" tabindex="0" aria-label="Resume playing">
        <svg aria-hidden="true" focusable="false" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <circle cx="32" cy="32" r="32" fill="black"/>
          <polygon points="26,20 50,32 26,44" fill="white"/>
        </svg>

        <div id="resumeBox" class="resume-box hidden" role="dialog" aria-live="polite">
          <div>Continue from <strong id="resumeTime">0:00</strong>?</div>
          <div class="resume-actions">
            <button id="resumeYes" class="resume-btn">Resume</button>
            <button id="resumeNo" class="resume-btn secondary">Start over</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="controls">
    <button id="playPauseBtn" aria-label="Play/Pause" class="icon-button" title="Play/Pause" type="button">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4fd1c5" d="M8 5v14l11-7z"/></svg>
    </button>

    <div id="progress-container"
         role="slider"
         aria-label="Video progress bar"
         tabindex="0"
         aria-valuemin="0"
         aria-valuemax="100"
         aria-valuenow="0"
         style="position: relative;">
      <div id="progress"></div>
      <div id="previewThumbnail" aria-hidden="true" role="presentation">
        <img id="previewImage" src="" alt="Preview thumbnail" />
      </div>
    </div>

    <div id="time-display" aria-live="off" aria-atomic="true">0:00 / 0:00</div>

    <button id="muteBtn" aria-label="Mute/Unmute" class="icon-button" title="Mute/Unmute" type="button">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4fd1c5" d="M3 9v6h4l5 5V4L7 9H3z"/><path fill="#4fd1c5" d="M16.5 12c0-1.77-1-3.29-2.5-4.03v8.06A4.97 4.97 0 0 0 16.5 12z"/></svg>
    </button>

    <input id="volumeSlider" type="range" min="0" max="100" value="100" aria-label="Volume" />

    <div class="control-group">
      <button id="speedBtn" type="button" title="Playback speed">1x</button>
      <div id="speedMenu" class="hidden" role="menu" aria-label="Playback speed">
        <button data-speed="0.5">0.5x</button>
        <button data-speed="0.75">0.75x</button>
        <button data-speed="1" class="active">1x</button>
        <button data-speed="1.25">1.25x</button>
        <button data-speed="1.5">1.5x</button>
        <button data-speed="1.75">1.75x</button>
        <button data-speed="2">2x</button>
      </div>
    </div>

    <button id="pipBtn" aria-label="Picture in Picture" class="icon-button" title="Picture in Picture" type="button">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="5" width="18" height="14" rx="2" fill="#4fd1c5"/>
        <rect x="12.5" y="11" width="7" height="5.5" rx="1.2" fill="#0f111a"/>
      </svg>
    </button>

    <button id="copyLinkBtn" aria-label="Copy link" class="icon-button" title="Copy link" type="button">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4fd1c5" d="M3.9 12a5 5 0 0 1 5-5h3v2h-3a3 3 0 1 0 0 6h3v2h-3a5 5 0 0 1-5-5zm7-1h2v2h-2v-2zm4.1-4h-3v2h3a3 3 0 1 1 0 6h-3v2h3a5 5 0 1 0 0-10z"/></svg>
    </button>

    <button id="maximizeBtn" aria-label="Maximize/Exit Fullscreen" class="icon-button" title="Maximize/Exit Fullscreen" type="button">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="#4fd1c5" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
    </button>
  </div>

  <button id="backBtn" aria-label="Back to Gojo Films" type="button">Back to Gojo Films</button>

  <section id="suggestedMovies" class="container mx-auto p-6">
    <h2 id="suggestedHeading" class="text-2xl font-semibold mb-6 text-cyan-400">Suggested Movies</h2>
    <div id="suggestedMoviesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </section>

 <script>
  (function () {
    // 1) Parse query
    function getQueryParams() {
      const params = {};
      location.search.substring(1).split("&").forEach(pair => {
        if (!pair) return;
        const [k, v] = pair.split("=");
        params[decodeURIComponent(k)] = decodeURIComponent(v || "");
      });
      return params;
    }
    const params = getQueryParams();
    const videoId = params.v || "";
    const title = params.t || "Gojo Films Video";
    const startTime = parseFloat(params.time || params.s || "0") || 0;
    let currentLang = (params.lang || localStorage.getItem('gojo_lang') || 'EN').toUpperCase();

    // 2) Elements
    const info = document.getElementById("info");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const pauseCover = document.getElementById("pauseCover");
    const suggestedMoviesGrid = document.getElementById("suggestedMoviesGrid");

    // 3) Suggested movies: from cached catalog (v3/v2) or small fallback
    function getCachedCatalog() {
      for (const key of ['gojo_catalog_v3', 'gojo_catalog_v2']) {
        try {
          const raw = localStorage.getItem(key);
          const cat = raw ? JSON.parse(raw) : null;
          if (cat?.items?.length) return cat;
        } catch {}
      }
      return null;
    }
    const FALLBACK_SUGGESTIONS = [
      { title: "ጥላዬ (Telaye) - Full Amharic Movie 2022", videoId: "SxVyFHDyrRI" },
      { title: "ወዳጅ (Wedaj) - Full Ethiopian Movie 2023", videoId: "phmIAGUlKVg" },
      { title: "ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId: "u4n1bBSWPHY" },
      { title: "ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId: "WIJU3F5Vrmc" }
    ];
    function loadSuggestedMovies() {
      suggestedMoviesGrid.innerHTML = "";
      let all = getCachedCatalog()?.items?.map(v => ({ title: v.title, videoId: v.videoId })) || FALLBACK_SUGGESTIONS;
      all = all.filter(v => v.videoId !== videoId).slice(0, 8);
      all.forEach(video => {
        const card = document.createElement("div");
        card.className = "video-card cursor-pointer";
        card.innerHTML = `
          <div class="relative" style="padding-bottom: 56.25%;">
            <img src="https://img.youtube.com/vi/${video.videoId}/hqdefault.jpg"
                 alt="${video.title.replace(/"/g, '&quot;')}"
                 loading="lazy"
                 class="absolute top-0 left-0 w-full h-full object-cover"/>
            <div class="play-icon absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                 aria-hidden="true">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="24" cy="24" r="22" fill="url(#grad1)" fill-opacity="0.7" />
                <path d="M20 17L33 24L20 31V17Z" fill="white" />
                <defs>
                  <linearGradient id="grad1" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
                    <stop stop-color="#4fd1c5" />
                    <stop offset="1" stop-color="#2c7a7b" />
                  </linearGradient>
                </defs>
              </svg>
            </div>
          </div>
          <h3 class="mt-2 text-sm font-medium text-gray-200" title="${video.title.replace(/"/g, '&quot;')}">
            ${video.title.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
          </h3>
        `;
        card.addEventListener("click", () => {
          const url = `player.html?v=${encodeURIComponent(video.videoId)}&t=${encodeURIComponent(video.title)}&lang=${encodeURIComponent(currentLang)}`;
          window.location.href = url;
        });
        suggestedMoviesGrid.appendChild(card);
        setTimeout(() => card.classList.add("loaded"), 50);
      });
    }
    // Show suggestions ASAP (don’t wait for YT)
    loadSuggestedMovies();

    // 4) Basic i18n text
    info.textContent = title;

    // 5) YouTube player
    let player, duration = 0;
    const playIconSVG = `<svg viewBox="0 0 24 24" fill="#4fd1c5" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z"/></svg>`;
    const pauseIconSVG = `<svg viewBox="0 0 24 24" fill="#4fd1c5" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>`;

    function updatePlayPauseBtn(isPlaying) {
      playPauseBtn.innerHTML = isPlaying ? pauseIconSVG : playIconSVG;
    }
    function showPause() { pauseCover.classList.remove('hidden'); }
    function hidePause() { pauseCover.classList.add('hidden'); }

    window.onYouTubeIframeAPIReady = function () {
      player = new YT.Player("player", {
        videoId,
        playerVars: {
          modestbranding: 1,
          rel: 0,
          iv_load_policy: 3,
          controls: 0,
          disablekb: 1,
          fs: 1,
          autoplay: 0,      // start paused
          playsinline: 1,
          origin: location.origin
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: onPlayerError
        }
      });
    };
    // Load the API
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onPlayerReady() {
      // Allow PiP/autoplay after gesture
      try {
        const iframe = player.getIframe();
        iframe.setAttribute('allow', 'autoplay; encrypted-media; picture-in-picture; fullscreen');
        iframe.setAttribute('allowfullscreen', 'true');
      } catch {}
      duration = player.getDuration();
      if (startTime > 0 && startTime < duration) player.seekTo(startTime, true);
      showPause();
      updatePlayPauseBtn(false);
    }

    function onStateChange(e) {
      switch (e.data) {
        case YT.PlayerState.PLAYING:
          hidePause();
          updatePlayPauseBtn(true);
          break;
        case YT.PlayerState.PAUSED:
          showPause();
          updatePlayPauseBtn(false);
          break;
        case YT.PlayerState.ENDED:
          showPause();
          updatePlayPauseBtn(false);
          break;
      }
    }
    function onPlayerError(err) {
      console.warn('YouTube player error', err);
    }

    // 6) Controls
    pauseCover.addEventListener("click", () => { if (player) player.playVideo(); });
    playPauseBtn.addEventListener("click", () => {
      if (!player) return;
      const s = player.getPlayerState();
      if (s === YT.PlayerState.PLAYING) player.pauseVideo();
      else player.playVideo();
    });

    // 7) Safety: log any blocking error early
    window.addEventListener('error', (e) => console.error('Script error:', e.message));
  })();
</script>
</body>
</html>

