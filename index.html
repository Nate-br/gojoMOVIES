<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ጎጆ films</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Fonts: Inter (UI), Noto Ethiopic (Amharic), Abyssinica SIL fallback -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Ethiopic:wght@400;600;700&family=Noto+Serif+Ethiopic:wght@600;700&family=Abyssinica+SIL:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-ui: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      --font-amharic-sans: "Noto Sans Ethiopic", "Abyssinica SIL", "Noto Sans", sans-serif;
      --font-amharic-serif: "Noto Serif Ethiopic", "Abyssinica SIL", serif;
      
      /* Professional color palette */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #252525;
      --bg-card: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-tertiary: #aaaaaa;
      --accent-primary: #FF5A5F;  /* Brand red */
      --accent-secondary: #00A699; /* Complementary teal */
      --accent-tertiary: #FF9900;  /* Warning/rating gold */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --shadow-subtle: 0 4px 12px rgba(0, 0, 0, 0.2);
      --shadow-strong: 0 8px 30px rgba(0, 0, 0, 0.4);
    }
    
    /* Base styling */
    body { 
      font-family: var(--font-ui);
      background-color: var(--bg-primary);
      color: var(--text-primary);
      letter-spacing: -0.011em;
      line-height: 1.5;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    /* Typography */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-ui);
      font-weight: 700;
      letter-spacing: -0.02em;
      margin: 0;
    }
    
    .amharic-text, 
    [lang="am"],
    .title-overlay, 
    #featuredHeading, 
    #suggestedHeading {
      font-family: var(--font-amharic-serif), var(--font-ui);
      font-feature-settings: "kern", "liga";
      text-rendering: optimizeLegibility;
    }
    
    /* Header */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 80%, rgba(0,0,0,0) 100%);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.3s ease;
    }
    
    header.scrolled {
      background: rgba(0,0,0,0.95);
    }
    
    header .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    header .logo .circle-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      color: white;
      font-weight: 800;
      font-size: 1.25rem;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 15px rgba(255, 90, 95, 0.5);
      user-select: none;
    }
    
    header .logo h1 {
      font-size: 1.75rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      user-select: none;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }
    
    /* Search */
    #searchIcon {
      position: relative;
      padding: 0.6rem;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #searchIcon:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }
    
    #searchInput {
      width: 0;
      opacity: 0;
      visibility: hidden;
      position: absolute;
      right: 0;
      top: calc(100% + 0.5rem);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
      outline: none;
      pointer-events: none;
      transition: all 0.3s ease;
      font-size: 0.95rem;
      box-shadow: var(--shadow-strong);
    }
    
    #searchInput.active {
      width: 240px;
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    
    /* Buttons */
    .btn {
      padding: 0.6rem 1.25rem;
      border-radius: 6px;
      border: none;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: var(--font-ui);
    }
    
    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #ff4147;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--accent-primary);
      color: var(--accent-primary);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 90, 95, 0.1);
      transform: translateY(-1px);
    }
    
    #langToggle {
      padding: 0.5rem 1.2rem;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      font-weight: 600;
      border: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #langToggle:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    #refreshBtn {
      padding: 0.6rem;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #refreshBtn:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }
    
    #refreshBtn svg {
      width: 18px;
      height: 18px;
    }
    
    /* Main content */
    main {
      margin-top: 180px;
      padding: 0 2rem;
      position: relative;
      z-index: 1;
    }
    
    /* Hero section */
    .hero-section {
      position: relative;
      width: 100%;
      max-height: 80vh;
      margin: 0 auto;
      margin-top: 60px;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .hero-background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      filter: brightness(0.5);
    }
    
    .hero-content {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 2rem;
      min-height: 500px;
      background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0) 100%);
    }
    
    .hero-title {
      font-size: 3rem;
      margin-bottom: 1rem;
      max-width: 60%;
    }
    
    .hero-description {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
      max-width: 50%;
      color: var(--text-secondary);
    }
    
    .hero-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    /* Tabs */
    .tabs-container {
      position: sticky;
      top: 70px;
      z-index: 50;
      display: flex;
      justify-content: flex-start;
      gap: 0.5rem;
      margin: 2rem 0;
      padding: 0.75rem 0;
      width: 100%;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow-x: auto;
      scrollbar-width: none;
      background: linear-gradient(180deg, rgba(18,18,18,0.9) 0%, rgba(18,18,18,0.5) 100%);
    }
    
    .tabs-container::-webkit-scrollbar {
      display: none;
    }
    
    .tab-button {
      padding: 0.6rem 1.25rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      font-size: 0.95rem;
      border: none;
      background: transparent;
      color: var(--text-tertiary);
      transition: all 0.2s ease;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .tab-button.active {
      background: var(--accent-primary);
      color: white;
    }
    
    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }
    
    /* Video sections */
    .video-section {
      margin-bottom: 3rem;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
      pointer-events: none;
    }
    
    .video-section.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .video-section h2 {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    /* Video card grid */
    .video-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.5rem;
    }
    
    @media (max-width: 768px) {
      .video-list {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
      }
    }
    
    /* Video cards */
    .video-card {
      position: relative;
      background: var(--bg-card);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-subtle);
      cursor: pointer;
    }
    
    .video-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: var(--shadow-strong);
      z-index: 2;
    }
    
    .video-card .thumbnail {
      position: relative;
      overflow: hidden;
      aspect-ratio: 16 / 9;
    }
    
    .video-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    
    .video-card:hover img {
      transform: scale(1.05);
    }
    
    .video-card .play-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 48px;
      height: 48px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .video-card:hover .play-icon {
      opacity: 1;
    }
    
    .video-card .info {
      padding: 1rem;
    }
    
    .video-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      height: 2.8em;
    }
    
    .video-card .meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .video-card .views {
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }
    
    .video-card .rating {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .video-card .rating svg {
      width: 14px;
      height: 14px;
      fill: var(--accent-tertiary);
    }
    
    .video-card .rating span {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent-tertiary);
    }
    
    /* Rating modal */
    .rating-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .rating-modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .rating-modal-content {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 2rem;
      max-width: 90%;
      width: 450px;
      text-align: center;
      box-shadow: var(--shadow-strong);
    }
    
    .rating-modal-title {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    
    #modalMovieTitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }
    
    .rating-modal-stars {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin: 1.5rem 0;
    }
    
    .rating-modal-stars .star {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .rating-modal-stars .star:hover {
      transform: scale(1.15);
    }
    
    .rating-modal-stars svg {
      width: 42px;
      height: 42px;
    }
    
    .rating-modal-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }
    
    /* Utilities */
    .spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Footer */
    footer {
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      padding: 3rem 2rem;
      margin-top: 4rem;
    }
    
    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 2rem;
    }
    
    .footer-column h4 {
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    .footer-column ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .footer-column li {
      margin-bottom: 0.75rem;
    }
    
    .footer-column a {
      color: var(--text-tertiary);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .footer-column a:hover {
      color: var(--accent-primary);
    }
    
    .footer-bottom {
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }
      
      header .logo h1 {
        font-size: 1.5rem;
      }
      
      .header-controls {
        gap: 0.75rem;
      }
      
      main {
        padding: 0 1rem;
      }
      
      .hero-title {
        font-size: 2rem;
        max-width: 100%;
      }
      
      .hero-description {
        font-size: 1rem;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header id="header">
    <div class="logo">
      <div class="circle-icon">ጎ</div>
      <h1>ጎጆ films</h1>
    </div>
    <div class="header-controls">
      <span id="searchIcon" role="button" tabindex="0" aria-label="Search">
        <svg viewBox="0 0 24 24" width="22" height="22" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.7.7l.27.28v.79l5.2 5.2 1.4-1.4-5.2-5.2zm-6 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z" fill="currentColor"/>
        </svg>
      </span>
      <input id="searchInput" type="text" placeholder="Search movies..." aria-label="Search movies" />
      <button id="refreshBtn" aria-label="Refresh catalog" title="Refresh catalog">
        <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
          <path fill="currentColor" d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a5 5 0 1 1-4.9 6h-2.1a7 7 0 1 0 12.65-6.65z"/>
        </svg>
      </button>
      <button id="langToggle">EN</button>
    </div>
  </header>

  <section class="hero-section">
    <img id="heroBackground" class="hero-background" src="https://img.youtube.com/vi/SxVyFHDyrRI/maxresdefault.jpg" alt="" />
    <div class="hero-content">
      <h2 class="hero-title" id="heroTitle">ጥላዬ (Telaye)</h2>
      <p class="hero-description" id="heroDescription">Watch the latest and greatest Amharic movies on ጎጆ films, your premium Ethiopian film platform.</p>
      <div class="hero-actions">
        <button class="btn btn-primary" id="heroPlayBtn">Watch Now</button>
        <button class="btn btn-secondary" id="heroInfoBtn">More Info</button>
      </div>
    </div>
  </section>

  <div class="tabs-container" role="tablist" aria-label="Movie categories">
    <button class="tab-button active" role="tab" aria-selected="true" aria-controls="new-releases">New Releases</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="popular">Popular</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="top-rated">Top Rated</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="most-viewed">Most Viewed</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="comedies">Comedies</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="dramas">Dramas</button>
  </div>

  <main>
    <section class="video-section active" id="new-releases" role="tabpanel">
      <h2>New Releases</h2>
      <div id="new-releases-grid" class="video-list"></div>
    </section>

    <section class="video-section" id="popular" role="tabpanel" hidden>
      <h2>Popular</h2>
      <div id="popular-grid" class="video-list"></div>
    </section>

    <section class="video-section" id="top-rated" role="tabpanel" hidden>
      <h2>Top Rated</h2>
      <div id="top-rated-grid" class="video-list"></div>
    </section>

    <section class="video-section" id="most-viewed" role="tabpanel" hidden>
      <h2>Most Viewed</h2>
      <div id="most-viewed-grid" class="video-list"></div>
    </section>
    
    <section class="video-section" id="comedies" role="tabpanel" hidden>
      <h2>Comedies</h2>
      <div id="comedies-grid" class="video-list"></div>
    </section>
    
    <section class="video-section" id="dramas" role="tabpanel" hidden>
      <h2>Dramas</h2>
      <div id="dramas-grid" class="video-list"></div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-column">
        <h4>ጎጆ films</h4>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Contact</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Browse</h4>
        <ul>
          <li><a href="#">New Releases</a></li>
          <li><a href="#">Top Rated</a></li>
          <li><a href="#">Comedies</a></li>
          <li><a href="#">Dramas</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Help</h4>
        <ul>
          <li><a href="#">FAQ</a></li>
          <li><a href="#">Terms of Service</a></li>
          <li><a href="#">Privacy Policy</a></li>
          <li><a href="#">Content Guidelines</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Connect</h4>
        <ul>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">Twitter</a></li>
          <li><a href="#">YouTube</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 ጎጆ films. All rights reserved.</p>
    </div>
  </footer>

  <!-- Rating Modal -->
  <div id="ratingModal" class="rating-modal">
    <div class="rating-modal-content">
      <h3 class="rating-modal-title">Rate this movie</h3>
      <div id="modalMovieTitle"></div>
      <div class="rating-modal-stars" id="modalStars">
        <span class="star" data-value="1">
          <svg viewBox="0 0 24 24" fill="#888888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        </span>
        <span class="star" data-value="2">
          <svg viewBox="0 0 24 24" fill="#888888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        </span>
        <span class="star" data-value="3">
          <svg viewBox="0 0 24 24" fill="#888888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        </span>
        <span class="star" data-value="4">
          <svg viewBox="0 0 24 24" fill="#888888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        </span>
        <span class="star" data-value="5">
          <svg viewBox="0 0 24 24" fill="#888888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        </span>
      </div>
      <div class="rating-modal-actions">
        <button id="cancelRatingBtn" class="btn btn-secondary">Cancel</button>
        <button id="submitRatingBtn" class="btn btn-primary">Submit Rating</button>
      </div>
    </div>
  </div>

  <script>
    // Endpoint and cache
    const CATALOG_ENDPOINT = `${location.origin}/api/catalog`;
    const CATALOG_KEY = 'gojo_catalog_v4'; // Updated version
    const RATINGS_KEY = 'gojo_ratings';
    const API_TTL_MS = 6 * 60 * 60 * 1000;
    
    // Enhanced YouTube API queries for Amharic content
    const ENHANCED_QUERIES = [
      'Amharic full movie 2023', 'Amharic full movie 2024', 'Ethiopian full movie',
      'አማርኛ ፊልም ሙሉ', 'Ethiopian comedy movie', 'Amharic drama full',
      'ሙሉ ፊልም', 'ዘመናዊ የኢትዮጵያ ፊልም', 'ኢትዮጵያን ፊልም', 'አዲስ የኢትዮጵያ ፊልም',
      'Ethiopia movie comedy', 'Ethiopia movie romance', 'Ethiopia movie action',
      'Ethiopian series', 'Amharic series full', 'ድራማ በአማርኛ'
    ];

    // Ratings system
    let currentRating = 0;
    let currentRatingVideoId = '';
    const ratings = JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}');
    
    // Calculate rating based on views
    function calculateRatingFromViews(viewCount) {
      if (!viewCount) return 3.5; // Default rating
      
      // Convert viewCount to a rating between 3.0-4.8
      if (viewCount >= 1000000) return 4.8;  // 1M+ views
      if (viewCount >= 500000) return 4.6;   // 500K+ views
      if (viewCount >= 200000) return 4.4;   // 200K+ views
      if (viewCount >= 100000) return 4.2;   // 100K+ views
      if (viewCount >= 50000) return 4.0;    // 50K+ views
      if (viewCount >= 20000) return 3.8;    // 20K+ views
      if (viewCount >= 10000) return 3.6;    // 10K+ views
      if (viewCount >= 5000) return 3.4;     // 5K+ views
      
      return 3.2; // Less than 5K views
    }
    
    function getAverageRating(videoId, viewCount) {
      // If we have user ratings, use those
      if (videoId && ratings[videoId] && ratings[videoId].length > 0) {
        const movieRatings = ratings[videoId];
        const sum = movieRatings.reduce((a, b) => a + b, 0);
        return sum / movieRatings.length;
      }
      
      // Otherwise calculate from view count
      return calculateRatingFromViews(viewCount);
    }
    
    function formatViewCount(count) {
      if (!count) return "N/A";
      if (count >= 1000000) return (count / 1000000).toFixed(1) + "M";
      if (count >= 1000) return (count / 1000).toFixed(1) + "K";
      return count.toString();
    }
    
    function saveRating(videoId, rating) {
      if (!videoId || rating < 1 || rating > 5) return;
      if (!ratings[videoId]) {
        ratings[videoId] = [];
      }
      ratings[videoId].push(rating);
      localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
      
      // Update UI for all instances of this movie
      document.querySelectorAll(`[data-video-id="${videoId}"] .rating span`).forEach(el => {
        const avgRating = getAverageRating(videoId);
        el.textContent = avgRating.toFixed(1);
      });
      
      // Refresh the Top Rated tab if it's active
      if (document.getElementById('top-rated').classList.contains('active')) {
        loadVideos('top-rated');
      }
    }
    
    const ratingModal = document.getElementById('ratingModal');
    const modalStars = document.querySelectorAll('#modalStars .star');
    const modalMovieTitle = document.getElementById('modalMovieTitle');
    const submitRatingBtn = document.getElementById('submitRatingBtn');
    const cancelRatingBtn = document.getElementById('cancelRatingBtn');
    
    function openRatingModal(videoId, title) {
      currentRatingVideoId = videoId;
      currentRating = 0;
      modalMovieTitle.textContent = title;
      modalStars.forEach(star => {
        star.querySelector('svg').setAttribute('fill', '#888888');
      });
      ratingModal.classList.add('active');
    }
    
    function closeRatingModal() {
      ratingModal.classList.remove('active');
      currentRatingVideoId = '';
      currentRating = 0;
    }
    
    modalStars.forEach(star => {
      star.addEventListener('click', () => {
        const value = parseInt(star.getAttribute('data-value'));
        currentRating = value;
        updateModalStars(value);
      });
      
      star.addEventListener('mouseover', () => {
        const value = parseInt(star.getAttribute('data-value'));
        updateModalStars(value, true);
      });
      
      star.addEventListener('mouseout', () => {
        updateModalStars(currentRating);
      });
    });
    
    function updateModalStars(value, isHover = false) {
      modalStars.forEach(star => {
        const starValue = parseInt(star.getAttribute('data-value'));
        const fill = starValue <= value ? '#FF9900' : '#888888';
        star.querySelector('svg').setAttribute('fill', fill);
      });
    }
    
    submitRatingBtn.addEventListener('click', () => {
      if (currentRating > 0 && currentRatingVideoId) {
        saveRating(currentRatingVideoId, currentRating);
      }
      closeRatingModal();
    });
    
    cancelRatingBtn.addEventListener('click', closeRatingModal);

    // Scroll effects for header
    window.addEventListener('scroll', () => {
      const header = document.getElementById('header');
      if (window.scrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
    });

    // Title cleaning function
    function cleanMovieTitle(title) {
      if (!title) return '';
      return title
        .replace(/\s*\|.*$/, '') // Remove pipe and everything after
        .replace(/\s*-\s*(Full|Ethiopian|Amharic|New).*$/i, '') // Remove standard suffixes
        .replace(/#\w+/g, '') // Remove hashtags
        .replace(/\s{2,}/g, ' ') // Fix multiple spaces
        .replace(/KATEX_INLINE_OPEN\d{4}KATEX_INLINE_CLOSE/, ' $& ') // Keep year in parentheses but clean spacing
        .replace(/full movie/i, '')
        .replace(/full ethiopian movie/i, '')
        .replace(/full amharic movie/i, '')
        .trim();
    }
    
    // Movie categorization by title keywords
    function categorizeByTitle(title) {
      const lowerTitle = title.toLowerCase();
      
      // Check for comedy indicators
      if (lowerTitle.includes('comedy') || 
          lowerTitle.includes('ኮሜዲ') || 
          lowerTitle.includes('ቀልድ') ||
          lowerTitle.includes('funny')) {
        return 'comedies';
      }
      
      // Check for drama indicators
      if (lowerTitle.includes('drama') || 
          lowerTitle.includes('ድራማ') || 
          lowerTitle.includes('መሰቃየት') ||
          lowerTitle.includes('ሐዘን')) {
        return 'dramas';
      }
      
      // Default category
      return null;
    }

    // Language pack
    const i18n = {
      EN: {
        featured: "Featured Movie",
        tabs: { 
          "new-releases": "New Releases", 
          popular: "Popular", 
          "top-rated": "Top Rated", 
          "most-viewed": "Most Viewed",
          "comedies": "Comedies",
          "dramas": "Dramas"
        },
        search: "Search movies...",
        rateThis: "Rate this movie",
        watchNow: "Watch Now",
        moreInfo: "More Info",
        views: "views"
      },
      AM: {
        featured: "የተመረጠ ፊልም",
        tabs: { 
          "new-releases": "አዲስ መተዎች", 
          popular: "ተወዳጅ", 
          "top-rated": "ከፍተኛ ደረጃ", 
          "most-viewed": "በጣም የታዩ",
          "comedies": "ኮሜዲዎች",
          "dramas": "ድራማዎች"
        },
        search: "ፊልሞችን ፈልግ...",
        rateThis: "ደረጃ ይስጡ",
        watchNow: "አሁን ይመልከቱ",
        moreInfo: "ተጨማሪ መረጃ",
        views: "ዕይታዎች"
      }
    };

    // Tabs
    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('.video-section');
    sections.forEach(s => { s.hidden = !s.classList.contains('active'); });
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetId = tab.getAttribute('aria-controls');
        tabs.forEach(t => {
          const selected = t === tab;
          t.classList.toggle('active', selected);
          t.setAttribute('aria-selected', selected ? 'true' : 'false');
        });
        sections.forEach(s => {
          const isTarget = s.id === targetId;
          s.classList.toggle('active', isTarget);
          s.hidden = !isTarget;
        });
      });
    });

    // Language
    let currentLang = localStorage.getItem('gojo_lang') || 'EN';
    function applyLanguage(lang) {
      const dict = i18n[lang] || i18n.EN;
      document.getElementById('langToggle').textContent = lang;
      document.getElementById('searchInput').placeholder = dict.search;
      
      // Update tab text
      document.querySelectorAll('.tabs-container .tab-button').forEach(tab => {
        const control = tab.getAttribute('aria-controls');
        tab.textContent = dict.tabs[control] || control;
      });
      
      // Update section headings
      sections.forEach(section => {
        const h2 = section.querySelector('h2');
        if (h2 && dict.tabs[section.id]) {
          h2.textContent = dict.tabs[section.id];
        }
      });
      
      // Update rating modal
      document.querySelector('.rating-modal-title').textContent = dict.rateThis;
      
      // Update hero buttons
      document.getElementById('heroPlayBtn').textContent = dict.watchNow;
      document.getElementById('heroInfoBtn').textContent = dict.moreInfo;
    }
    
    applyLanguage(currentLang);
    document.getElementById('langToggle').addEventListener('click', () => {
      currentLang = currentLang === 'EN' ? 'AM' : 'EN';
      localStorage.setItem('gojo_lang', currentLang);
      applyLanguage(currentLang);
    });

    // Grid rendering
    let movieVideos = [];
    function loadVideos(category) {
      const grid = document.getElementById(`${category}-grid`);
      if (!grid) return;
      
      grid.innerHTML = "";
      
      let filtered = movieVideos.filter(v => {
        // For comedies and dramas, use content-based categorization
        if (category === 'comedies' || category === 'dramas') {
          return v.categories?.includes(category);
        }
        
        // For other categories, use the assigned category
        return v.category === category;
      });
      
      // Apply sorting based on category
      if (category === 'top-rated') {
        filtered.sort((a, b) => {
          const ratingA = getAverageRating(a.videoId, a.viewCount) || 0;
          const ratingB = getAverageRating(b.videoId, b.viewCount) || 0;
          return ratingB - ratingA;
        });
      } else if (category === 'most-viewed') {
        filtered.sort((a, b) => {
          const viewsA = a.viewCount || 0;
          const viewsB = b.viewCount || 0;
          return viewsB - viewsA;
        });
      } else if (category === 'new-releases') {
        filtered.sort((a, b) => {
          const dateA = a.publishedAt || 0;
          const dateB = b.publishedAt || 0;
          return dateB - dateA;
        });
      }
      
      filtered.forEach(video => {
        const videoCard = document.createElement("div");
        videoCard.className = "video-card fade-in";
        videoCard.setAttribute('data-video-id', video.videoId);
        
        const cleanTitle = cleanMovieTitle(video.title);
        const avgRating = getAverageRating(video.videoId, video.viewCount);
        const viewText = i18n[currentLang].views || "views";
        
        videoCard.innerHTML = `
          <div class="thumbnail">
            <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" 
                 alt="${cleanTitle.replace(/"/g, '&quot;')}" 
                 loading="lazy" />
            <div class="play-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </div>
          </div>
          <div class="info">
            <h3 title="${cleanTitle.replace(/"/g, '&quot;')}">
              ${cleanTitle.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </h3>
            <div class="meta">
              <div class="views">${formatViewCount(video.viewCount)} ${viewText}</div>
              <div class="rating" title="Rate this movie">
                <svg viewBox="0 0 24 24" fill="#FF9900" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                </svg>
                <span>${avgRating.toFixed(1)}</span>
              </div>
            </div>
          </div>
        `;
        
        // Set up event listeners
        videoCard.querySelector('.rating').addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent navigation to player
          openRatingModal(video.videoId, cleanTitle);
        });
        
        videoCard.addEventListener("click", (e) => {
          if (e.target.closest('.rating')) return; // Don't navigate if clicking rating
          window.location.href = `player.html?v=${encodeURIComponent(video.videoId)}&t=${encodeURIComponent(cleanTitle)}&lang=${encodeURIComponent(currentLang)}`;
        });
        
        grid.appendChild(videoCard);
      });
    }

    // Search
    const searchIcon = document.getElementById('searchIcon');
    const searchInput = document.getElementById('searchInput');
    searchIcon.addEventListener('click', () => {
      searchInput.classList.toggle('active');
      if (searchInput.classList.contains('active')) searchInput.focus();
    });
    
    searchInput.addEventListener('blur', () => {
      setTimeout(() => {
        searchInput.classList.remove('active');
        searchInput.value = '';
      }, 200);
    });
    
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      sections.forEach(section => {
        if (section.hidden) return;
        
        const grid = section.querySelector('.video-list');
        const cards = grid.getElementsByClassName('video-card');
        Array.from(cards).forEach(card => {
          const title = card.querySelector('h3').textContent.toLowerCase();
          card.style.display = title.includes(query) ? '' : 'none';
        });
      });
    });

    // Hero section
    function updateHero(item) {
      if (!item) return;
      
      const cleanTitle = cleanMovieTitle(item.title);
      const heroTitle = document.getElementById('heroTitle');
      const heroBackground = document.getElementById('heroBackground');
      
      // Use higher quality image for hero background
      heroBackground.src = `https://img.youtube.com/vi/${item.videoId}/maxresdefault.jpg`;
      heroBackground.onerror = () => {
        // Fallback to hqdefault if maxresdefault is not available
        heroBackground.src = `https://img.youtube.com/vi/${item.videoId}/hqdefault.jpg`;
      };
      
      heroTitle.textContent = cleanTitle;
      
      // Setup hero button events
      document.getElementById('heroPlayBtn').onclick = () => {
        window.location.href = `player.html?v=${encodeURIComponent(item.videoId)}&t=${encodeURIComponent(cleanTitle)}&lang=${encodeURIComponent(currentLang)}`;
      };
      
      document.getElementById('heroInfoBtn').onclick = () => {
        openRatingModal(item.videoId, cleanTitle);
      };
    }

    // Cache helpers
    function getCachedCatalog() {
      try {
        const raw = localStorage.getItem(CATALOG_KEY);
        if (!raw) return null;
        const cat = JSON.parse(raw);
        if (!cat?.fetchedAt) return null;
        if (Date.now() - cat.fetchedAt > API_TTL_MS) return null;
        return cat;
      } catch { return null; }
    }
    
    function setCachedCatalog(cat) {
      try { localStorage.setItem(CATALOG_KEY, JSON.stringify(cat)); } catch {}
    }

    // Build from catalog
    function setFromCatalog(cat) {
      movieVideos = [];
      
      // Extract all items with metadata
      const items = cat.items || [];
      const categoriesMap = cat.categories || {};
      
      // Make a mapping of videoId to metadata
      const metadataMap = {};
      items.forEach(item => {
        if (item.videoId) {
          metadataMap[item.videoId] = {
            viewCount: item.viewCount || Math.floor(Math.random() * 100000),
            publishedAt: item.publishedAt || Date.now(),
            durationSec: item.durationSec
          };
        }
      });
      
      // Process each category
      const categories = [
        'new-releases', 'popular', 'trending', 'classics',
        'comedies', 'dramas'
      ];
      
      // Map old categories to new ones
      const categoryMapping = {
        'trending': 'top-rated',
        'classics': 'most-viewed'
      };
      
      categories.forEach(oldCat => {
        const catItems = categoriesMap[oldCat] || [];
        const newCat = categoryMapping[oldCat] || oldCat;
        
        catItems.forEach(item => {
          if (!item.videoId) return;
          
          // Get metadata for this video
          const metadata = metadataMap[item.videoId] || {
            viewCount: Math.floor(Math.random() * 100000),
            publishedAt: Date.now()
          };
          
          // Determine content categories based on title
          const contentCategory = categorizeByTitle(item.title);
          const categories = contentCategory ? [contentCategory] : [];
          
          // Create enriched video object
          const enrichedVideo = {
            ...item,
            ...metadata,
            category: newCat,
            categories: categories
          };
          
          movieVideos.push(enrichedVideo);
        });
      });
      
      // Find content-based categories for any uncategorized videos
      movieVideos.forEach(video => {
        if (!video.categories || !video.categories.length) {
          const contentCategory = categorizeByTitle(video.title);
          if (contentCategory) {
            video.categories = [contentCategory];
          } else {
            video.categories = [];
          }
        }
      });
      
      // Load videos for each section
      ['new-releases', 'popular', 'top-rated', 'most-viewed', 'comedies', 'dramas'].forEach(loadVideos);
      
      // Update hero with a featured new release
      const featuredVideos = movieVideos.filter(v => v.category === 'new-releases');
      if (featuredVideos.length) {
        featuredVideos.sort((a, b) => b.viewCount - a.viewCount);
        updateHero(featuredVideos[0]);
      }
    }

    // Fallback catalog with improved data
    const FALLBACK_CATALOG = {
      fetchedAt: Date.now(),
      items: [
        { 
          title: "ጥላዬ (Telaye) - Full Amharic Movie 2022", 
          videoId: "SxVyFHDyrRI", 
          viewCount: 252463, 
          publishedAt: Date.now() - (30 * 24 * 60 * 60 * 1000),
          durationSec: 7200
        },
        { 
          title: "ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", 
          videoId: "WIJU3F5Vrmc", 
          viewCount: 183294, 
          publishedAt: Date.now() - (7 * 24 * 60 * 60 * 1000),
          durationSec: 6800
        },
        { 
          title: "ወዳጅ (Wedaj) - Full Ethiopian Movie 2023", 
          videoId: "phmIAGUlKVg", 
          viewCount: 385742, 
          publishedAt: Date.now() - (90 * 24 * 60 * 60 * 1000),
          durationSec: 7500
        },
        { 
          title: "ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", 
          videoId: "u4n1bBSWPHY", 
          viewCount: 695231, 
          publishedAt: Date.now() - (365 * 24 * 60 * 60 * 1000),
          durationSec: 8000
        },
        { 
          title: "ድራማ - የምር ፍቅር Ethiopian Drama", 
          videoId: "pWYWcpbIKZ4", 
          viewCount: 125674, 
          publishedAt: Date.now() - (45 * 24 * 60 * 60 * 1000),
          durationSec: 5400
        },
        { 
          title: "የኮሜዲ አዋጪ - Ethiopian Comedy Movie", 
          videoId: "pJ7Gk6UdtJM", 
          viewCount: 238541, 
          publishedAt: Date.now() - (20 * 24 * 60 * 60 * 1000),
          durationSec: 6200
        }
      ],
      categories: {
        'new-releases': [
          { title: "ጥላዬ (Telaye) - Full Amharic Movie 2022", videoId: "SxVyFHDyrRI" },
          { title: "ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId: "WIJU3F5Vrmc" }
        ],
        'popular': [
          { title: "ወዳጅ (Wedaj) - Full Ethiopian Movie 2023", videoId: "phmIAGUlKVg" },
          { title: "የኮሜዲ አዋጪ - Ethiopian Comedy Movie", videoId: "pJ7Gk6UdtJM" }
        ],
        'trending': [
          { title: "ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId: "u4n1bBSWPHY" },
          { title: "ድራማ - የምር ፍቅር Ethiopian Drama", videoId: "pWYWcpbIKZ4" }
        ],
        'classics': [
          { title: "ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId: "WIJU3F5Vrmc" },
          { title: "ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId: "u4n1bBSWPHY" }
        ],
        'comedies': [
          { title: "የኮሜዲ አዋጪ - Ethiopian Comedy Movie", videoId: "pJ7Gk6UdtJM" }
        ],
        'dramas': [
          { title: "ድራማ - የምር ፍቅር Ethiopian Drama", videoId: "pWYWcpbIKZ4" }
        ]
      }
    };
    
    function setFromFallback() { 
      setFromCatalog(FALLBACK_CATALOG); 
    }
    
    function isCatalogEmpty(cat) {
      const cats = cat?.categories || {};
      return ['new-releases', 'popular', 'trending', 'classics']
        .every(k => !Array.isArray(cats[k]) || cats[k].length === 0);
    }

    // Fetch from serverless (with fallback)
    async function fetchCatalog(force=false) {
      const cached = !force && getCachedCatalog();
      if (cached && !isCatalogEmpty(cached)) {
        setFromCatalog(cached);
        return cached;
      }
      
      const btn = document.getElementById('refreshBtn');
      const original = btn.innerHTML;
      
      try {
        btn.disabled = true;
        btn.innerHTML = `<svg class="spinner" viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="42"/></svg>`;
        
        // Include enhanced queries as URL parameters
        const queryParams = new URLSearchParams();
        if (force) queryParams.set('force', '1');
        queryParams.set('queries', ENHANCED_QUERIES.join(','));
        
        const url = `${CATALOG_ENDPOINT}?${queryParams.toString()}`;
        const res = await fetch(url, { cache: force ? 'no-store' : 'default' });
        
        if (!res.ok) throw new Error('Fetch failed');
        
        const cat = await res.json();
        if (!cat?.categories || isCatalogEmpty(cat)) {
          setFromFallback();
          return FALLBACK_CATALOG;
        }
        
        setCachedCatalog(cat);
        setFromCatalog(cat);
        return cat;
      } catch (e) {
        const raw = localStorage.getItem(CATALOG_KEY);
        if (raw) {
          try {
            const old = JSON.parse(raw);
            if (!isCatalogEmpty(old)) { setFromCatalog(old); return old; }
          } catch {}
        }
        setFromFallback();
        return FALLBACK_CATALOG;
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
    }

    // Init
    fetchCatalog(false);
    document.getElementById('refreshBtn').addEventListener('click', () => {
      fetchCatalog(true);
    });
  </script>
</body>
</html>
