<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ጎጆ films</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Ethiopic:wght@400;600;700&family=Noto+Serif+Ethiopic:wght@600;700&family=Abyssinica+SIL:wght@400;700&display=swap" rel="stylesheet">

  <!-- Supabase UMD (stable) -->
  <script>
    window.SUPABASE_URL = 'https://fuidgrbtqnjphhyiouxn.supabase.co';
    window.SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1aWRncmJ0cW5qcGhoeWlvdXhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxOTE3ODcsImV4cCI6MjA3Mjc2Nzc4N30.tlX59jWeSzmHcX1voQ9Pi3z_k-AjoJkf-cM2I8Cx8dA';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script>
    window.supabase = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON);
  </script>

  <style>
    :root{
      --font-ui:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      --font-amharic-sans:"Noto Sans Ethiopic","Abyssinica SIL","Noto Sans",sans-serif;
      --font-amharic-serif:"Noto Serif Ethiopic","Abyssinica SIL",serif;
      --bg-primary:#0a0a0a;--bg-secondary:#141414;--bg-tertiary:#181818;--bg-card:#202020;
      --text-primary:#fff;--text-secondary:#e0e0e0;--text-tertiary:#b3b3b3;
      --accent-primary:#e50914;--accent-secondary:#ff2d20;--accent-tertiary:#FFC107;
      --border-subtle:rgba(255,255,255,.1);
      --shadow-strong:0 8px 30px rgba(0,0,0,.4);--shadow-subtle:0 4px 12px rgba(0,0,0,.2)
    }
    body{font-family:var(--font-ui);background:var(--bg-primary);color:var(--text-primary);margin:0;overflow-x:hidden;line-height:1.5}
    body::after{content:"";position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:-1}
    h1,h2,h3{margin:0;font-weight:700}
    header{position:fixed;inset:0 0 auto 0;z-index:100;background:rgba(10,10,10,.95);backdrop-filter:blur(10px);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.4)}
    header .logo{display:flex;align-items:center;gap:.75rem}
    .circle-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--accent-primary);color:#fff;font-weight:900;font-size:1.25rem;box-shadow:0 0 15px rgba(229,9,20,.3);user-select:none}
    header .logo h1{font-size:1.75rem}
    .header-controls{display:flex;align-items:center;gap:1rem;position:relative}
    #searchIcon{width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);cursor:pointer}
    #searchIcon:hover{background:rgba(255,255,255,.2)}
    #searchInput{width:0;opacity:0;visibility:hidden;position:absolute;right:0;top:calc(100% + .5rem);padding:.75rem 1rem;border-radius:8px;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-subtle);box-shadow:var(--shadow-strong);transition:all .3s}
    #searchInput.active{width:260px;opacity:1;visibility:visible;pointer-events:auto}
    .btn{padding:.6rem 1.1rem;border-radius:6px;border:1px solid transparent;font-weight:600;font-size:.9rem;cursor:pointer;transition:.2s}
    .btn-primary{background:var(--accent-primary);color:#fff}.btn-primary:hover{background:var(--accent-secondary)}
    .btn-secondary{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);color:#fff}.btn-secondary:hover{background:rgba(255,255,255,.12)}
    #userMenu{position:relative}#userDropdown{position:absolute;right:0;top:calc(100% + 6px);background:var(--bg-tertiary);border:1px solid var(--border-subtle);border-radius:8px;min-width:180px;display:none;box-shadow:var(--shadow-strong)}
    #userDropdown .btn{width:100%;text-align:left;background:transparent;border:none;border-radius:0}
    main{margin-top:180px;padding:0 2rem}
    .hero-section{position:relative;overflow:hidden;border-radius:8px;margin-top:60px}
    .hero-background{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.5)}
    .hero-content{position:relative;z-index:1;display:flex;flex-direction:column;justify-content:flex-end;padding:2rem;min-height:500px;background:linear-gradient(0deg,rgba(0,0,0,.9),rgba(0,0,0,.4) 50%,rgba(0,0,0,0))}
    .hero-title{font-size:3rem;margin-bottom:1rem;max-width:60%}
    .hero-description{font-size:1.1rem;color:var(--text-secondary);max-width:60%}
    .hero-actions{display:flex;gap:1rem;margin-top:1rem}
    .tabs-container{position:sticky;top:70px;z-index:50;display:flex;justify-content:center;gap:.5rem;margin:2rem auto;padding:.75rem 1.5rem;max-width:1200px;background:linear-gradient(180deg,rgba(10,10,10,.9),rgba(10,10,10,.5));backdrop-filter:blur(10px);overflow-x:auto;scrollbar-width:none}
    .tabs-container::-webkit-scrollbar{display:none}
    .tab-button{padding:.6rem 1.25rem;border:none;border-radius:6px;font-weight:600;color:var(--text-tertiary);background:transparent;cursor:pointer;white-space:nowrap}
    .tab-button.active{background:var(--accent-primary);color:#fff}
    .video-section{max-width:1200px;margin:0 auto 3rem;opacity:0;transform:translateY(20px);transition:all .5s;pointer-events:none}
    .video-section.active{opacity:1;transform:translateY(0);pointer-events:auto}
    .video-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1.5rem}
    @media(max-width:768px){.video-list{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem}.hero-title{font-size:2rem;max-width:100%}.hero-description{max-width:100%}#searchInput.active{width:min(80vw,280px)}}
    .video-card{position:relative;background:var(--bg-card);border-radius:4px;overflow:hidden;transition:transform .25s, box-shadow .25s;box-shadow:var(--shadow-subtle);cursor:pointer}
    .video-card:hover{transform:translateY(-6px) scale(1.03)}
    .thumbnail{position:relative;aspect-ratio:16/9;overflow:hidden}
    .thumbnail img{width:100%;height:100%;object-fit:cover;transition:transform .5s}
    .video-card:hover .thumbnail img{transform:scale(1.05)}
    .play-icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:48px;height:48px;background:rgba(0,0,0,.65);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
    .video-card:hover .play-icon{opacity:1}
    .info{padding:1rem}.info h3{font-size:1rem;font-weight:600;margin:0 0 .5rem;height:2.8em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .meta{display:flex;align-items:center;justify-content:space-between}
    .views{font-size:.85rem;color:var(--text-tertiary)}
    .rating{display:flex;align-items:center;gap:.25rem}.rating svg{width:14px;height:14px;fill:var(--accent-tertiary)}
    .overlay-actions{position:absolute;top:8px;right:8px;display:flex;gap:6px;z-index:3}
    .overlay-actions button{width:32px;height:32px;border-radius:50%;border:none;background:rgba(0,0,0,.55);color:#fff;cursor:pointer}
    .overlay-actions button.active{background:var(--accent-primary)}
    .pagination-controls{display:flex;justify-content:center;align-items:center;gap:.75rem;margin:2rem 0}
    .pagination-btn{padding:.5rem 1rem;border-radius:4px;background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border-subtle);cursor:pointer}
    .pagination-btn:disabled{opacity:.5;cursor:not-allowed}
    .page-indicator{font-size:.9rem;color:var(--text-tertiary)}
    footer{background:var(--bg-secondary);color:var(--text-tertiary);padding:3rem 2rem;margin-top:4rem}
    .footer-content{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:2rem}
    .footer-column h4{margin-bottom:1rem;color:#fff}
    .footer-bottom{margin-top:2rem;padding-top:1rem;border-top:1px solid var(--border-subtle);text-align:center}
    /* Rating modal */
    .rating-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(5px);opacity:0;pointer-events:none;transition:.3s}
    .rating-modal.active{opacity:1;pointer-events:auto}
    .rating-modal-content{background:var(--bg-secondary);border-radius:8px;padding:2rem;max-width:90%;width:450px;text-align:center;box-shadow:var(--shadow-strong)}
    .rating-modal-stars{display:flex;justify-content:center;gap:.75rem;margin:1.5rem 0}
    .rating-modal-stars svg{width:42px;height:42px}
  </style>
</head>

<body>
  <header id="header">
    <div class="logo">
      <!-- Red “ጎ” logo -->
      <div id="logoMark" class="circle-icon" title="ጎ">ጎ</div>
      <h1>ጎጆ films</h1>
    </div>
    <div class="header-controls">
      <span id="searchIcon" role="button" tabindex="0" aria-label="Search">
        <svg viewBox="0 0 24 24" width="22" height="22" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.7.7l.27.28v.79l5.2 5.2 1.4-1.4-5.2-5.2zm-6 0a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z" fill="currentColor"/>
        </svg>
      </span>
      <input id="searchInput" type="text" placeholder="Search movies..." aria-label="Search movies" />
      <button id="refreshBtn" aria-label="Refresh catalog" title="Refresh catalog">
        <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg">
          <path fill="currentColor" d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a5 5 0 1 1-4.9 6h-2.1a7 7 0 1 0 12.65-6.65z"/>
        </svg>
      </button>
      <button id="langToggle">EN</button>

      <!-- Auth -->
      <button id="loginBtn" class="btn btn-secondary">Login</button>
      <div id="userMenu" class="btn btn-secondary" style="display:none;">
        <span id="userName">Profile</span>
        <div id="userDropdown">
          <button id="myListBtn" class="btn">My List</button>
          <a id="adminLink" href="admin.html" class="btn" style="display:none;">Admin</a>
          <button id="logoutBtn" class="btn">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <section class="hero-section">
    <!-- Static first image (shows even if API fails) -->
    <img id="heroBackground" class="hero-background" src="https://img.youtube.com/vi/SxVyFHDyrRI/maxresdefault.jpg" alt="" />
    <div class="hero-content">
      <h2 class="hero-title" id="heroTitle">ጥላዬ (Telaye)</h2>
      <p class="hero-description" id="heroDescription">Watch the latest and greatest Ethiopian films on ጎጆ films.</p>
      <div class="hero-actions">
        <button class="btn btn-primary" id="heroPlayBtn">Watch Now</button>
        <button class="btn btn-secondary" id="heroInfoBtn">More Info</button>
      </div>
    </div>
  </section>

  <div class="tabs-container" role="tablist" aria-label="Movie categories">
    <button class="tab-button active" role="tab" aria-selected="true" aria-controls="new-releases">New Releases</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="popular">Popular</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="top-rated">Top Rated</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="most-viewed">Most Viewed</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="comedies">Comedies</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="dramas">Dramas</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="my-list" id="myListTab">My List</button>
    <button class="tab-button" role="tab" aria-selected="false" aria-controls="search-results" id="searchTab" hidden>Search</button>
  </div>

  <main>
    <section class="video-section active" id="new-releases" role="tabpanel">
      <h2>New Releases</h2>
      <div id="new-releases-grid" class="video-list"></div>
      <div id="new-releases-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="popular" role="tabpanel" hidden>
      <h2>Popular</h2>
      <div id="popular-grid" class="video-list"></div>
      <div id="popular-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="top-rated" role="tabpanel" hidden>
      <h2>Top Rated</h2>
      <div id="top-rated-grid" class="video-list"></div>
      <div id="top-rated-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="most-viewed" role="tabpanel" hidden>
      <h2>Most Viewed</h2>
      <div id="most-viewed-grid" class="video-list"></div>
      <div id="most-viewed-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="comedies" role="tabpanel" hidden>
      <h2>Comedies</h2>
      <div id="comedies-grid" class="video-list"></div>
      <div id="comedies-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="dramas" role="tabpanel" hidden>
      <h2>Dramas</h2>
      <div id="dramas-grid" class="video-list"></div>
      <div id="dramas-pagination" class="pagination-controls">
        <button class="pagination-btn prev-page" disabled>Previous</button>
        <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">1</span></span>
        <button class="pagination-btn next-page">Next</button>
      </div>
    </section>

    <section class="video-section" id="my-list" role="tabpanel" hidden>
      <h2>My List</h2>
      <div id="my-list-grid" class="video-list"></div>
      <div class="page-indicator" id="myListCount" style="margin-top:1rem;color:var(--text-tertiary);"></div>
    </section>

    <section class="video-section" id="search-results" role="tabpanel" hidden>
      <h2>Search Results</h2>
      <div id="search-results-grid" class="video-list"></div>
      <div class="page-indicator" style="margin-top:1rem;color:var(--text-tertiary);" id="searchCount"></div>
    </section>
  </main>

  <footer>
    <div class="footer-content">
      <div class="footer-column">
        <h4>ጎጆ films</h4>
        <ul>
          <li><a href="#">About Us</a></li><li><a href="#">Contact</a></li>
          <li><a href="#">Careers</a></li><li><a href="#">Press</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Browse</h4>
        <ul>
          <li><a href="#">New Releases</a></li><li><a href="#">Top Rated</a></li>
          <li><a href="#">Comedies</a></li><li><a href="#">Dramas</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Help</h4>
        <ul>
          <li><a href="#">FAQ</a></li><li><a href="#">Terms of Service</a></li>
          <li><a href="#">Privacy Policy</a></li><li><a href="#">Content Guidelines</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h4>Connect</h4>
        <ul>
          <li><a href="#">Facebook</a></li><li><a href="#">Instagram</a></li>
          <li><a href="#">Twitter</a></li><li><a href="#">YouTube</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom"><p>&copy; 2025 ጎጆ films. All rights reserved.</p></div>
  </footer>

  <!-- Rating Modal -->
  <div id="ratingModal" class="rating-modal">
    <div class="rating-modal-content">
      <h3 class="rating-modal-title">Rate this movie</h3>
      <div id="modalMovieTitle"></div>
      <div class="rating-modal-stars" id="modalStars">
        <span class="star" data-value="1"><svg viewBox="0 0 24 24" fill="#888"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>
        <span class="star" data-value="2"><svg viewBox="0 0 24 24" fill="#888"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>
        <span class="star" data-value="3"><svg viewBox="0 0 24 24" fill="#888"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>
        <span class="star" data-value="4"><svg viewBox="0 0 24 24" fill="#888"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>
        <span class="star" data-value="5"><svg viewBox="0 0 24 24" fill="#888"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></span>
      </div>
      <div style="display:flex;gap:1rem;justify-content:center;margin-top:2rem;">
        <button id="cancelRatingBtn" class="btn btn-secondary">Cancel</button>
        <button id="submitRatingBtn" class="btn btn-primary">Submit Rating</button>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal.active{display:flex}
    .modal-card{background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:10px;padding:1.25rem;width:min(90vw,400px);box-shadow:var(--shadow-strong)}
    .modal-card input{width:100%;margin-bottom:.75rem;padding:.6rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-tertiary);color:#fff}
  </style>
  <div id="authModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3>Login / Sign up</h3>
      <input id="authEmail" type="email" placeholder="Email"/>
      <input id="authPass" type="password" placeholder="Password"/>
      <div style="display:flex;gap:.5rem;">
        <button id="authLogin" class="btn btn-primary" style="flex:1;">Login</button>
        <button id="authSignup" class="btn btn-secondary" style="flex:1;">Sign Up</button>
      </div>
      <button id="authClose" class="btn btn-secondary" style="margin-top:.75rem;width:100%;">Close</button>
    </div>
  </div>

 <script>
  // Show any runtime errors in console so we don't silently fail
  window.addEventListener('error', (e) => console.error('JS error:', e.message, e.error || ''));
  window.addEventListener('unhandledrejection', (e) => console.error('Promise rejection:', e.reason || e));

  // Endpoint and cache
  const CATALOG_ENDPOINT = `${location.origin}/api/catalog`;
  const CATALOG_KEY = 'gojo_catalog_v4';
  const RATINGS_KEY = 'gojo_ratings';
  const API_TTL_MS = 6 * 60 * 60 * 1000;

  // Pagination
  const VIDEOS_PER_PAGE = 12;
  const paginationState = {
    'new-releases': { currentPage: 1, totalPages: 1 },
    'popular': { currentPage: 1, totalPages: 1 },
    'top-rated': { currentPage: 1, totalPages: 1 },
    'most-viewed': { currentPage: 1, totalPages: 1 },
    'comedies': { currentPage: 1, totalPages: 1 },
    'dramas': { currentPage: 1, totalPages: 1 }
  };

  // Queries
  const ENHANCED_QUERIES = [
    'Amharic full movie 2024','Ethiopian full movie 2024','አማርኛ ፊልም ሙሉ 2024',
    'Amharic full movie 2023','Ethiopian full movie 2023','አማርኛ ፊልም ሙሉ 2023',
    'Amharic full movie 2022','Ethiopian full movie 2022','አማርኛ ፊልም ሙሉ 2022',
    'Ethiopian comedy movie','Amharic comedy movie','የኢትዮጵያ ኮሜዲ ፊልም',
    'Ethiopian drama movie','Amharic drama movie','የኢትዮጵያ ድራማ ፊልም',
    'amharic movies','ye wendoch guday'
  ];

  // Elements (auth UI)
  const loginBtn = document.getElementById('loginBtn');
  const userMenu = document.getElementById('userMenu');
  const userName = document.getElementById('userName');
  const userDropdown = document.getElementById('userDropdown');
  const logoutBtn = document.getElementById('logoutBtn');
  const myListBtn = document.getElementById('myListBtn');
  const adminLink = document.getElementById('adminLink');
  const authModal = document.getElementById('authModal');

  // Safe Supabase wrappers (so UI still works if Supabase JS fails to load)
  const hasSupabase = !!(window.supabase && window.supabase.auth && typeof window.supabase.auth.getUser === 'function');

  async function safeGetUser() {
    try { if (!hasSupabase) return { data: { user: null }, error: null }; return await supabase.auth.getUser(); }
    catch (e) { console.warn('safeGetUser', e); return { data: { user: null }, error: e }; }
  }
  async function safeSignIn(email, password) {
    if (!hasSupabase) throw new Error('Auth not available');
    return supabase.auth.signInWithPassword({ email, password });
  }
  async function safeSignUp(email, password) {
    if (!hasSupabase) throw new Error('Auth not available');
    return supabase.auth.signUp({ email, password });
  }
  async function safeSignOut() {
    try { if (hasSupabase) await supabase.auth.signOut(); } catch {}
  }
  async function safeSelect(table, columns) {
    if (!hasSupabase) return { data: null, error: null };
    return supabase.from(table).select(columns);
  }
  function onAuthStateChangeSafe(cb) {
    if (hasSupabase && supabase.auth.onAuthStateChange) supabase.auth.onAuthStateChange(cb);
  }

  // Dropdown
  function toggleDropdown(show) { if (userDropdown) userDropdown.style.display = show ? 'block' : 'none'; }
  if (userMenu) userMenu.addEventListener('click', () => toggleDropdown(userDropdown.style.display !== 'block'));
  document.addEventListener('click', (e) => { if (!userMenu.contains(e.target)) toggleDropdown(false); });

  // Attach auth button handlers BEFORE any async calls so UI always responds
  if (loginBtn) loginBtn.addEventListener('click', () => authModal.classList.add('active'));
  const closeBtn = document.getElementById('authClose');
  if (closeBtn) closeBtn.onclick = () => authModal.classList.remove('active');

  const loginAction = document.getElementById('authLogin');
  const signupAction = document.getElementById('authSignup');
  if (loginAction) loginAction.onclick = async () => {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPass').value.trim();
    try {
      const { error } = await safeSignIn(email, password);
      if (error) { console.error(error); alert('Login failed: ' + error.message); return; }
      authModal.classList.remove('active');
      refreshAuthUI();  // safe call
    } catch (e) {
      alert('Login not available right now. Try again in a moment.');
    }
  };
  if (signupAction) signupAction.onclick = async () => {
    const email = document.getElementById('authEmail').value.trim();
    const password = document.getElementById('authPass').value.trim();
    try {
      const { error } = await safeSignUp(email, password);
      if (error) { console.error(error); alert('Signup failed: ' + error.message); return; }
      alert('Signup successful. If confirmation is enabled, check your email.');
      authModal.classList.remove('active');
      refreshAuthUI();
    } catch (e) {
      alert('Signup not available right now. Try again in a moment.');
    }
  };
  if (logoutBtn) logoutBtn.addEventListener('click', async () => { await safeSignOut(); refreshAuthUI(); });
  if (myListBtn) myListBtn.addEventListener('click', () => document.querySelector('[aria-controls="my-list"]')?.click());

  if (hasSupabase) onAuthStateChangeSafe(() => refreshAuthUI());

  // Library state
  window.__liked = new Set();
  window.__watchLater = new Set();

  async function ensureAuthed() {
    const { data: { user } } = await safeGetUser();
    if (!user) { authModal.classList.add('active'); throw new Error('Login required'); }
    return user;
  }
  async function preloadUserLibrary() {
    const { data: { user } } = await safeGetUser();
    __liked.clear(); __watchLater.clear();
    if (!user || !hasSupabase) return;
    try {
      const [likes, wl] = await Promise.all([
        supabase.from('likes').select('video_id').limit(500),
        supabase.from('watch_later').select('video_id').limit(500)
      ]);
      (likes.data || []).forEach(r => __liked.add(r.video_id));
      (wl.data || []).forEach(r => __watchLater.add(r.video_id));
    } catch (e) {
      console.warn('preloadUserLibrary', e);
    }
  }

  async function refreshAuthUI() {
    try {
      const { data: { user } } = await safeGetUser();
      if (user) {
        if (loginBtn) loginBtn.style.display = 'none';
        if (userMenu) userMenu.style.display = 'inline-flex';
        try {
          let display = user.email ? user.email.split('@')[0] : 'User';
          if (hasSupabase) {
            const { data: profile } = await supabase.from('profiles').select('display_name, role').eq('id', user.id).maybeSingle();
            if (profile?.display_name) display = profile.display_name;
            if (adminLink) adminLink.style.display = profile?.role === 'admin' ? 'block' : 'none';
          }
          if (userName) userName.textContent = display;
        } catch {}
        await preloadUserLibrary();
        reloadAllGrids();
        renderMyList();
      } else {
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (userMenu) userMenu.style.display = 'none';
        __liked.clear(); __watchLater.clear();
        renderMyList();
      }
    } catch (e) {
      console.warn('refreshAuthUI', e);
      if (loginBtn) loginBtn.style.display = 'inline-flex';
      if (userMenu) userMenu.style.display = 'none';
    }
  }

  // Library actions
  async function handleLikeToggle(e, videoId, title) {
    e.stopPropagation();
    try {
      const user = await ensureAuthed();
      if (!hasSupabase) return;
      const { data } = await supabase.from('likes').select('video_id').eq('user_id', user.id).eq('video_id', videoId).maybeSingle();
      if (data) {
        await supabase.from('likes').delete().match({ user_id: user.id, video_id: videoId });
        __liked.delete(videoId);
        e.currentTarget.classList.remove('active');
      } else {
        await supabase.from('likes').upsert({ user_id: user.id, video_id: videoId, title });
        __liked.add(videoId);
        e.currentTarget.classList.add('active');
      }
      renderMyList();
    } catch (err) { console.warn(err.message); }
  }
  async function handleWatchLaterToggle(e, videoId, title) {
    e.stopPropagation();
    try {
      const user = await ensureAuthed();
      if (!hasSupabase) return;
      const { data } = await supabase.from('watch_later').select('video_id').eq('user_id', user.id).eq('video_id', videoId).maybeSingle();
      if (data) {
        await supabase.from('watch_later').delete().match({ user_id: user.id, video_id: videoId });
        __watchLater.delete(videoId);
        e.currentTarget.classList.remove('active');
      } else {
        await supabase.from('watch_later').upsert({ user_id: user.id, video_id: videoId, title });
        __watchLater.add(videoId);
        e.currentTarget.classList.add('active');
      }
      renderMyList();
    } catch (err) { console.warn(err.message); }
  }

  // Ratings
  const ratings = JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}');
  function calculateRatingFromViews(viewCount) {
    if (!viewCount) return 3.5;
    if (viewCount >= 1000000) return 4.8; if (viewCount >= 500000) return 4.6; if (viewCount >= 200000) return 4.4;
    if (viewCount >= 100000) return 4.2; if (viewCount >= 50000) return 4.0; if (viewCount >= 20000) return 3.8;
    if (viewCount >= 10000) return 3.6; if (viewCount >= 5000) return 3.4; return 3.2;
  }
  function getAverageRating(videoId, viewCount) {
    if (ratings[videoId]?.length) { const s = ratings[videoId].reduce((a,b)=>a+b,0); return s / ratings[videoId].length; }
    return calculateRatingFromViews(viewCount);
  }
  function saveRating(videoId, rating) {
    if (!ratings[videoId]) ratings[videoId] = [];
    ratings[videoId].push(rating);
    localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
    document.querySelectorAll(`[data-video-id="${videoId}"] .rating span`).forEach(el => el.textContent = (getAverageRating(videoId)).toFixed(1));
    if (document.getElementById('top-rated').classList.contains('active')) loadVideos('top-rated', paginationState['top-rated'].currentPage);
  }
  const ratingModal = document.getElementById('ratingModal');
  const modalStars = document.querySelectorAll('#modalStars .star');
  const modalMovieTitle = document.getElementById('modalMovieTitle');
  const submitRatingBtn = document.getElementById('submitRatingBtn');
  const cancelRatingBtn = document.getElementById('cancelRatingBtn');
  let currentRating = 0, currentRatingVideoId = '';
  function openRatingModal(videoId, title) {
    currentRatingVideoId = videoId; currentRating = 0; modalMovieTitle.textContent = title;
    modalStars.forEach(s => s.querySelector('svg').setAttribute('fill', '#888')); ratingModal.classList.add('active');
  }
  function closeRatingModal() { ratingModal.classList.remove('active'); currentRating = 0; currentRatingVideoId=''; }
  modalStars.forEach(star => {
    star.addEventListener('click', () => { currentRating = parseInt(star.dataset.value); updateModalStars(currentRating); });
    star.addEventListener('mouseover', () => updateModalStars(parseInt(star.dataset.value)));
    star.addEventListener('mouseout', () => updateModalStars(currentRating));
  });
  function updateModalStars(v) { modalStars.forEach(st => { const f = (parseInt(st.dataset.value) <= v) ? '#FFC107' : '#888'; st.querySelector('svg').setAttribute('fill', f); }); }
  if (submitRatingBtn) submitRatingBtn.addEventListener('click', () => { if (currentRating && currentRatingVideoId) saveRating(currentRatingVideoId, currentRating); closeRatingModal(); });
  if (cancelRatingBtn) cancelRatingBtn.addEventListener('click', closeRatingModal);

  // Header scroll
  window.addEventListener('scroll', () => {
    const h = document.getElementById('header'); if (!h) return;
    if (scrollY > 50) h.classList.add('scrolled'); else h.classList.remove('scrolled');
  });

  // Language
  const i18n = {
    EN:{tabs:{"new-releases":"New Releases",popular:"Popular","top-rated":"Top Rated","most-viewed":"Most Viewed",comedies:"Comedies",dramas:"Dramas","my-list":"My List","search-results":"Search"},search:"Search movies...",views:"views",previous:"Previous",next:"Next",watchNow:"Watch Now",moreInfo:"More Info"},
    AM:{tabs:{"new-releases":"አዲስ መተዎች",popular:"ተወዳጅ","top-rated":"ከፍተኛ ደረጃ","most-viewed":"በጣም የታዩ",comedies:"ኮሜዲዎች",dramas:"ድራማዎች","my-list":"የኔ ዝርዝር","search-results":"ፍለጋ"},search:"ፊልሞችን ፈልግ...",views:"ዕይታዎች",previous:"ቀዳሚ",next:"ቀጣይ",watchNow:"አሁን ይመልከቱ",moreInfo:"ተጨማሪ መረጃ"}
  };
  let currentLang = localStorage.getItem('gojo_lang') || 'EN';
  function applyLanguage(lang) {
    const d = i18n[lang] || i18n.EN;
    const langToggle = document.getElementById('langToggle');
    if (langToggle) langToggle.textContent = lang;
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.placeholder = d.search;
    document.querySelectorAll('.tabs-container .tab-button').forEach(tab => { const c = tab.getAttribute('aria-controls'); tab.textContent = d.tabs[c] || c; });
    const hp = document.getElementById('heroPlayBtn'), hi = document.getElementById('heroInfoBtn');
    if (hp) hp.textContent = d.watchNow; if (hi) hi.textContent = d.moreInfo;
    document.querySelectorAll('.pagination-controls').forEach(p => {
      p.querySelector('.prev-page')?.textContent = d.previous;
      p.querySelector('.next-page')?.textContent = d.next;
    });
  }
  applyLanguage(currentLang);
  const langToggleBtn = document.getElementById('langToggle');
  if (langToggleBtn) langToggleBtn.addEventListener('click', () => { currentLang = currentLang === 'EN' ? 'AM' : 'EN'; localStorage.setItem('gojo_lang', currentLang); applyLanguage(currentLang); });

  // Tabs
  const tabs = document.querySelectorAll('.tab-button');
  const sections = document.querySelectorAll('.video-section');
  sections.forEach(s => { s.hidden = !s.classList.contains('active'); });
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetId = tab.getAttribute('aria-controls');
      tabs.forEach(t => { const sel = t === tab; t.classList.toggle('active', sel); t.setAttribute('aria-selected', sel ? 'true' : 'false'); });
      sections.forEach(s => { const on = s.id === targetId; s.classList.toggle('active', on); s.hidden = !on; });
    });
  });

  // Search (mobile-friendly)
  const searchIcon = document.getElementById('searchIcon');
  const searchInput = document.getElementById('searchInput');
  const searchTab = document.getElementById('searchTab');
  const searchGrid = document.getElementById('search-results-grid');
  const searchCount = document.getElementById('searchCount');
  let lastTabId = 'new-releases';
  function switchToTab(id) {
    const tabBtn = document.querySelector(`[aria-controls="${id}"]`);
    tabs.forEach(t => { const sel = t === tabBtn; t.classList.toggle('active', sel); t.setAttribute('aria-selected', sel ? 'true' : 'false'); });
    sections.forEach(s => { const on = s.id === id; s.classList.toggle('active', on); s.hidden = !on; });
  }
  function openSearch() {
    searchInput.classList.add('active'); searchTab.hidden = false;
    lastTabId = document.querySelector('.tab-button.active')?.getAttribute('aria-controls') || 'new-releases';
    switchToTab('search-results'); searchInput.focus();
  }
  function closeSearch() {
    searchInput.value = ''; searchInput.classList.remove('active'); searchTab.hidden = true;
    switchToTab(lastTabId); searchGrid.innerHTML = ''; if (searchCount) searchCount.textContent = '';
  }
  if (searchIcon) searchIcon.addEventListener('click', openSearch);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSearch(); });
  tabs.forEach(tab => tab.addEventListener('click', () => { const id = tab.getAttribute('aria-controls'); if (id !== 'search-results') lastTabId = id; }));
  let searchTimer;
  if (searchInput) searchInput.addEventListener('input', () => {
    const q = searchInput.value.trim().toLowerCase();
    if (!q) { closeSearch(); return; }
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => {
      const results = movieVideos.filter(v => (cleanMovieTitle(v.title) || '').toLowerCase().includes(q));
      renderSearchResults(results);
    }, 180);
  });
  function renderSearchResults(results) {
    switchToTab('search-results');
    searchGrid.innerHTML = '';
    const viewText = i18n[currentLang].views || 'views';
    results.slice(0, 150).forEach(video => {
      const cleanTitle = cleanMovieTitle(video.title);
      const avgRating = getAverageRating(video.videoId, video.viewCount);
      const card = document.createElement('div'); card.className = 'video-card';
      card.innerHTML = `
        <div class="thumbnail">
          <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" alt="${cleanTitle.replace(/"/g,'&quot;')}" loading="lazy"/>
          <div class="play-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg></div>
        </div>
        <div class="info">
          <h3 title="${cleanTitle.replace(/"/g,'&quot;')}">${cleanTitle.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</h3>
          <div class="meta">
            <div class="views">${formatViewCount(video.viewCount)} ${viewText}</div>
            <div class="rating"><svg viewBox="0 0 24 24" fill="#FFC107"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg><span>${avgRating.toFixed(1)}</span></div>
          </div>
        </div>`;
      card.addEventListener('click', () => { location.href = `player.html?v=${encodeURIComponent(video.videoId)}&t=${encodeURIComponent(cleanTitle)}&lang=${encodeURIComponent(currentLang)}`; });
      searchGrid.appendChild(card);
    });
    if (searchCount) searchCount.textContent = `${results.length} result(s)`;
  }

  // Helpers
  function categorizeByTitle(title) {
    const t = (title || '').toLowerCase(); const cats = [];
    if (t.includes('comedy') || t.includes('ኮሜዲ') || t.includes('ቀልድ')) cats.push('comedies');
    if (t.includes('drama') || t.includes('ድራማ') || t.includes('ፍቅር')) cats.push('dramas');
    return cats;
  }
  function cleanMovieTitle(title) {
    if (!title) return '';
    return title
      .replace(/\s*\|.*$/, '')
      .replace(/\s*-\s*(Full|Ethiopian|Amharic|New).*$/i, '')
      .replace(/#\w+/g, '')
      .replace(/KATEX_INLINE_OPEN(?:19|20)\d{2}KATEX_INLINE_CLOSE/g, ' ($&)')   // keep (year)
      .replace(/full (ethiopian|amharic)?\s*movie/ig, '')
      .replace(/\s{2,}/g, ' ')
      .trim();
  }
  function formatViewCount(count) {
    if (!count) return 'N/A';
    if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
    if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
    return String(count);
  }

  // Grid render
  let movieVideos = []; let heroList = []; let heroTimer = null; let heroIndex = 0;

  function loadVideos(category, page = 1) {
    const grid = document.getElementById(`${category}-grid`); if (!grid) return;
    grid.innerHTML = '';
    let filtered = movieVideos.filter(v => {
      if (category === 'comedies' || category === 'dramas') return v.categories?.includes(category);
      return v.category === category;
    });
    if (category === 'top-rated') filtered.sort((a,b) => getAverageRating(b.videoId,b.viewCount) - getAverageRating(a.videoId,a.viewCount));
    else if (category === 'most-viewed') filtered.sort((a,b) => (b.viewCount||0) - (a.viewCount||0));
    else if (category === 'new-releases') filtered.sort((a,b) => (b.publishedAt||0) - (a.publishedAt||0));

    const totalVideos = filtered.length;
    const totalPages = Math.max(1, Math.ceil(totalVideos / VIDEOS_PER_PAGE));
    paginationState[category].totalPages = totalPages;
    paginationState[category].currentPage = Math.min(page, totalPages);
    const start = (paginationState[category].currentPage - 1) * VIDEOS_PER_PAGE;
    const pageItems = filtered.slice(start, start + VIDEOS_PER_PAGE);

    pageItems.forEach(video => {
      const cleanTitle = cleanMovieTitle(video.title);
      const avgRating = getAverageRating(video.videoId, video.viewCount);
      const viewText = i18n[currentLang].views || 'views';
      const isLiked = __liked.has(video.videoId);
      const isSaved = __watchLater.has(video.videoId);
      const card = document.createElement('div'); card.className = 'video-card'; card.setAttribute('data-video-id', video.videoId);
      card.innerHTML = `
        <div class="thumbnail">
          <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" alt="${cleanTitle.replace(/"/g,'&quot;')}" loading="lazy"/>
          <div class="overlay-actions">
            <button class="btn-like ${isLiked?'active':''}" title="Like" aria-label="Like">❤</button>
            <button class="btn-save ${isSaved?'active':''}" title="Watch later" aria-label="Watch later">⏱</button>
          </div>
          <div class="play-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg></div>
        </div>
        <div class="info">
          <h3 title="${cleanTitle.replace(/"/g,'&quot;')}">${cleanTitle.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</h3>
          <div class="meta">
            <div class="views">${formatViewCount(video.viewCount)} ${viewText}</div>
            <div class="rating"><svg viewBox="0 0 24 24" fill="#FFC107"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg><span>${avgRating.toFixed(1)}</span></div>
          </div>
        </div>`;
      card.querySelector('.rating').addEventListener('click', (e) => { e.stopPropagation(); openRatingModal(video.videoId, cleanTitle); });
      card.querySelector('.btn-like').addEventListener('click', (e) => handleLikeToggle(e, video.videoId, cleanTitle));
      card.querySelector('.btn-save').addEventListener('click', (e) => handleWatchLaterToggle(e, video.videoId, cleanTitle));
      card.addEventListener('click', () => { location.href = `player.html?v=${encodeURIComponent(video.videoId)}&t=${encodeURIComponent(cleanTitle)}&lang=${encodeURIComponent(currentLang)}`; });
      grid.appendChild(card);
    });

    updatePaginationControls(category);
  }
  function updatePaginationControls(category) {
    const p = document.getElementById(`${category}-pagination`); if (!p) return;
    const state = paginationState[category];
    p.querySelector('.current-page').textContent = state.currentPage;
    p.querySelector('.total-pages').textContent = state.totalPages;
    p.querySelector('.prev-page').disabled = state.currentPage <= 1;
    p.querySelector('.next-page').disabled = state.currentPage >= state.totalPages;
  }
  function setupPaginationListeners() {
    document.querySelectorAll('.pagination-controls').forEach(control => {
      const category = control.id.replace('-pagination', '');
      control.querySelector('.prev-page')?.addEventListener('click', () => {
        if (paginationState[category].currentPage > 1) { paginationState[category].currentPage--; loadVideos(category, paginationState[category].currentPage); }
      });
      control.querySelector('.next-page')?.addEventListener('click', () => {
        if (paginationState[category].currentPage < paginationState[category].totalPages) { paginationState[category].currentPage++; loadVideos(category, paginationState[category].currentPage); }
      });
    });
  }

  // Hero
  function updateHero(item) {
    if (!item) return;
    const cleanTitle = cleanMovieTitle(item.title);
    const bg = document.getElementById('heroBackground');
    document.getElementById('heroTitle').textContent = cleanTitle;
    bg.src = `https://img.youtube.com/vi/${item.videoId}/maxresdefault.jpg`;
    bg.onerror = () => { bg.src = `https://img.youtube.com/vi/${item.videoId}/hqdefault.jpg`; };
    document.getElementById('heroPlayBtn').onclick = () => { location.href = `player.html?v=${encodeURIComponent(item.videoId)}&t=${encodeURIComponent(cleanTitle)}&lang=${encodeURIComponent(currentLang)}`; };
    document.getElementById('heroInfoBtn').onclick = () => openRatingModal(item.videoId, cleanTitle);
  }
  function startHeroRotation(list) {
    clearInterval(heroTimer); heroList = list || []; heroIndex = 0;
    if (heroList.length === 0) return;
    updateHero(heroList[0]);
    if (heroList.length > 1) {
      heroTimer = setInterval(() => { heroIndex = (heroIndex + 1) % heroList.length; updateHero(heroList[heroIndex]); }, 7000);
    }
  }

  // Catalog cache
  function getCachedCatalog() {
    try {
      const raw = localStorage.getItem(CATALOG_KEY); if (!raw) return null;
      const cat = JSON.parse(raw); if (!cat?.fetchedAt) return null;
      if (Date.now() - cat.fetchedAt > API_TTL_MS) return null;
      return cat;
    } catch { return null; }
  }
  function setCachedCatalog(cat) { try { localStorage.setItem(CATALOG_KEY, JSON.stringify(cat)); } catch {} }

  // Build from catalog
  function setFromCatalog(cat) {
    movieVideos = [];
    const items = cat.items || [], categoriesMap = cat.categories || {};
    const metadataMap = {};
    items.forEach(item => {
      if (item.videoId) {
        metadataMap[item.videoId] = {
          viewCount: item.viewCount || Math.floor(Math.random() * 100000),
          publishedAt: item.publishedAt || Date.now(),
          durationSec: item.durationSec,
          categories: item.categories || []
        };
      }
    });
    const categories = ['new-releases','popular','trending','classics','comedies','dramas'];
    const categoryMapping = { 'trending':'top-rated', 'classics':'most-viewed' };
    categories.forEach(old => {
      const list = categoriesMap[old] || [];
      const mapped = categoryMapping[old] || old;
      list.forEach(it => {
        if (!it.videoId) return;
        const md = metadataMap[it.videoId] || { viewCount: Math.floor(Math.random() * 100000), publishedAt: Date.now(), categories: [] };
        const contentCats = md.categories?.length ? md.categories : categorizeByTitle(it.title);
        movieVideos.push({ ...it, ...md, category: mapped, categories: contentCats });
      });
    });
    movieVideos.forEach(v => { if (!v.categories?.length) v.categories = categorizeByTitle(v.title); });
    Object.keys(paginationState).forEach(k => paginationState[k].currentPage = 1);
    ['new-releases','popular','top-rated','most-viewed','comedies','dramas'].forEach(cat => loadVideos(cat, 1));

    const featured = movieVideos.filter(v => v.category === 'new-releases').sort((a,b) => (b.viewCount||0) - (a.viewCount||0));
    startHeroRotation(featured.slice(0,8));
  }

  // Fallback catalog (always shows movies, even if API or JS fails earlier)
  const FALLBACK_CATALOG = {
    fetchedAt: Date.now(),
    items: [
      { title:"ጥላዬ (Telaye) - Full Amharic Movie 2022", videoId:"SxVyFHDyrRI", viewCount:252463, publishedAt:Date.now()-30*86400000, durationSec:7200 },
      { title:"ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId:"WIJU3F5Vrmc", viewCount:183294, publishedAt:Date.now()-7*86400000, durationSec:6800 },
      { title:"ወዳጅ (Wedaj) - Full Ethiopian Movie 2023", videoId:"phmIAGUlKVg", viewCount:385742, publishedAt:Date.now()-90*86400000, durationSec:7500 },
      { title:"ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId:"u4n1bBSWPHY", viewCount:695231, publishedAt:Date.now()-365*86400000, durationSec:8000 },
      { title:"ድራማ - የምር ፍቅር Ethiopian Drama", videoId:"pWYWcpbIKZ4", viewCount:125674, publishedAt:Date.now()-45*86400000, durationSec:5400, categories:["dramas"] },
      { title:"የኮሜዲ አዋጪ - Ethiopian Comedy Movie", videoId:"pJ7Gk6UdtJM", viewCount:238541, publishedAt:Date.now()-20*86400000, durationSec:6200, categories:["comedies"] },
      { title:"ፍቅር ቃል - Fikir Kal Ethiopian Movie", videoId:"QM-9NY8BFQU", viewCount:345218, publishedAt:Date.now()-75*86400000, durationSec:6500, categories:["dramas"] },
      { title:"ተውኔት - Tewinet Full Ethiopian Movie", videoId:"9Iq6EPu7tFU", viewCount:156390, publishedAt:Date.now()-120*86400000, durationSec:7200 },
      { title:"አሌክስ - Alex New Ethiopian Movie", videoId:"uLSqvvCS9OU", viewCount:526840, publishedAt:Date.now()-60*86400000, durationSec:6900 },
      { title:"ምርጫ - Mircha Ethiopian Movie", videoId:"oAiYvE9MYVU", viewCount:412367, publishedAt:Date.now()-40*86400000, durationSec:6800 },
      { title:"ቁስል - Kusil Ethiopian Movie", videoId:"Bd2MZ7e4p7s", viewCount:187569, publishedAt:Date.now()-95*86400000, durationSec:7300 },
      { title:"ሰማይ ነው - Semay New Ethiopian Movie", videoId:"1xhBnFAXZ2Q", viewCount:298745, publishedAt:Date.now()-15*86400000, durationSec:7000 },
      { title:"ሰይጣን ተጫወተብኝ - Ethiopian Comedy", videoId:"6dVjd-2SZ0Q", viewCount:354120, publishedAt:Date.now()-25*86400000, durationSec:5800, categories:["comedies"] },
      { title:"ሙሉ ፊልም - Mulu Film Ethiopian Full Movie 2024", videoId:"mCp3LNoL4Jk", viewCount:120560, publishedAt:Date.now()-5*86400000, durationSec:7500 },
      { title:"ትዕግስት - Tigist Ethiopian Full Movie", videoId:"kV_2lWDiGL4", viewCount:287436, publishedAt:Date.now()-55*86400000, durationSec:6700 }
    ],
    categories: {
      'new-releases': [
        { title:"ጥላዬ (Telaye) - Full Amharic Movie 2022", videoId:"SxVyFHDyrRI" },
        { title:"ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId:"WIJU3F5Vrmc" },
        { title:"ሰማይ ነው - Semay New Ethiopian Movie", videoId:"1xhBnFAXZ2Q" },
        { title:"ሙሉ ፊልም - Mulu Film Ethiopian Full Movie 2024", videoId:"mCp3LNoL4Jk" }
      ],
      'popular': [
        { title:"ወዳጅ (Wedaj) - Full Ethiopian Movie 2023", videoId:"phmIAGUlKVg" },
        { title:"የኮሜዲ አዋጪ - Ethiopian Comedy Movie", videoId:"pJ7Gk6UdtJM" },
        { title:"አሌክስ - Alex New Ethiopian Movie", videoId:"uLSqvvCS9OU" },
        { title:"ሰይጣን ተጫወተብኝ - Ethiopian Comedy", videoId:"6dVjd-2SZ0Q" }
      ],
      'trending': [
        { title:"ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId:"u4n1bBSWPHY" },
        { title:"ድራማ - የምር ፍቅር Ethiopian Drama", videoId:"pWYWcpbIKZ4" },
        { title:"ምርጫ - Mircha Ethiopian Movie", videoId:"oAiYvE9MYVU" },
        { title:"ትዕግስት - Tigist Ethiopian Full Movie", videoId:"kV_2lWDiGL4" }
      ],
      'classics': [
        { title:"ባለ ክራር (Bale Kirar) - Ethiopian Full Movie 2024", videoId:"WIJU3F5Vrmc" },
        { title:"ወይኔ የአራዳ ልጅ 5 (Wayne Yarada Lij 5) - Full Movie 2020", videoId:"u4n1bBSWPHY" },
        { title:"ተውኔት - Tewinet Full Ethiopian Movie", videoId:"9Iq6EPu7tFU" },
        { title:"ቁስል - Kusil Ethiopian Movie", videoId:"Bd2MZ7e4p7s" }
      ],
      'comedies': [
        { title:"የኮሜዲ አዋጪ - Ethiopian Comedy Movie", videoId:"pJ7Gk6UdtJM" },
        { title:"ሰይጣን ተጫወተብኝ - Ethiopian Comedy", videoId:"6dVjd-2SZ0Q" }
      ],
      'dramas': [
        { title:"ድራማ - የምር ፍቅር Ethiopian Drama", videoId:"pWYWcpbIKZ4" },
        { title:"ፍቅር ቃል - Fikir Kal Ethiopian Movie", videoId:"QM-9NY8BFQU" }
      ]
    }
  };

  function isCatalogEmpty(cat) {
    const cs = cat?.categories || {};
    return ['new-releases','popular','trending','classics'].every(k => !Array.isArray(cs[k]) || cs[k].length === 0);
  }

  async function fetchCatalog(force=false) {
    const cached = !force && getCachedCatalog();
    if (cached && !isCatalogEmpty(cached)) { setFromCatalog(cached); return cached; }
    const btn = document.getElementById('refreshBtn'); const original = btn ? btn.innerHTML : '';
    try {
      if (btn) { btn.disabled = true; btn.innerHTML = `<svg class="spinner" viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-dasharray="42"/></svg>`; }
      const q = new URLSearchParams(); if (force) q.set('force','1'); q.set('queries', ENHANCED_QUERIES.join(','));
      const url = `${CATALOG_ENDPOINT}?${q.toString()}`;
      const res = await fetch(url, { cache: force ? 'no-store' : 'default' });
      if (!res.ok) throw new Error('catalog fetch failed');
      const cat = await res.json();
      if (!cat?.categories || isCatalogEmpty(cat)) { setFromCatalog(FALLBACK_CATALOG); return FALLBACK_CATALOG; }
      setCachedCatalog(cat); setFromCatalog(cat); return cat;
    } catch (e) {
      console.warn('Catalog error, using fallback:', e);
      const raw = localStorage.getItem(CATALOG_KEY);
      if (raw) { try { const old = JSON.parse(raw); if (!isCatalogEmpty(old)) { setFromCatalog(old); return old; } } catch {} }
      setFromCatalog(FALLBACK_CATALOG); return FALLBACK_CATALOG;
    } finally {
      if (btn) { btn.disabled = false; btn.innerHTML = original; }
    }
  }

  // Init: 1) movies (always show), 2) bind pagination, 3) auth UI (safe)
  fetchCatalog(false).then(() => setupPaginationListeners()).catch(() => setFromCatalog(FALLBACK_CATALOG));
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) refreshBtn.addEventListener('click', () => { fetchCatalog(true).then(() => setupPaginationListeners()); });

  // Run after attaching handlers so the login button always works
  refreshAuthUI();
</script>
</body>
</html>

